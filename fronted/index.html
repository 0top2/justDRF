<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustDRF | æå®¢åšå®¢</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        /* --- 1. å…¨å±€è®¾è®¡ç³»ç»Ÿ --- */
        :root {
            /* å“ç‰Œè‰²ï¼šæ›´æœ‰ç§‘æŠ€æ„Ÿçš„é›è“ */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            /* è¾…åŠ©è‰² */
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b; /* è‰ç¨¿é¢œè‰² */
            /* æ–‡æœ¬è‰² */
            --text-main: #1e293b;
            --text-light: #64748b;
            /* èƒŒæ™¯ä½“ç³» */
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.9); /* æ¯›ç»ç’ƒåŸºç¡€ */
            --radius: 16px;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            background-color: var(--bg-color);
            /* é«˜çº§ç½‘æ ¼èƒŒæ™¯å›¾ */
            background-image:
                radial-gradient(at 40% 20%, hsla(250,100%,94%,1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,96%,1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(341,100%,96%,1) 0px, transparent 50%),
                radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 24px 24px;
            background-position: 0 0, 0 0, 0 0, 0 0;
        }

        /* --- 2. å¯¼èˆªæ  --- */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }
        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0.8rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.5px;
        }
        .user-menu-btn {
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
            padding: 4px 12px 4px 4px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 30px;
            transition: all 0.2s;
        }
        .user-menu-btn:hover { border-color: var(--primary); box-shadow: 0 2px 8px rgba(79, 70, 229, 0.15); }
        .user-avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        .dropdown {
            position: absolute; right: 0; top: 50px;
            background: white; width: 180px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: none; border: 1px solid #f1f5f9;
            animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }
        .dropdown.show { display: block; }
        .dropdown-item { padding: 12px 16px; display: block; cursor: pointer; font-size: 0.9rem; color: var(--text-main); }
        .dropdown-item:hover { background: #f8fafc; color: var(--primary); }

        /* --- 3. å¸ƒå±€ä¸è§†å›¾ --- */
        .main-container {
            max-width: 900px; margin: 2rem auto; padding: 0 1.5rem;
            animation: fadeIn 0.4s ease;
        }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- 4. å¡ç‰‡ä¸æŒ‰é’®ä½“ç³» --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: var(--radius);
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .btn {
            padding: 10px 20px; border-radius: 10px;
            font-weight: 600; font-size: 0.95rem;
            border: none; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }

        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }

        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: #fecaca; }

        /* --- 5. åˆ—è¡¨é¡µç»„ä»¶ --- */
        .search-container { position: relative; margin-bottom: 2rem; }
        .search-input {
            width: 100%; padding: 16px 20px 16px 48px;
            border-radius: 14px; border: none;
            background: white;
            box-shadow: var(--shadow);
            font-size: 1rem; color: var(--text-main);
            transition: all 0.2s;
        }
        .search-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .post-card {
            background: white; border-radius: var(--radius);
            padding: 1.8rem; margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid transparent;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: #e2e8f0;
        }

        /* æ ‡ç­¾ä¸å¾½ç«  */
        .tag-badge { background: #e0e7ff; color: var(--primary); padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-right: 6px; }
        .status-badge {
            font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;
            font-weight: bold; border: 1px solid; margin-right: 8px; vertical-align: middle;
        }
        .status-draft { background: #fffbeb; color: var(--warning); border-color: #fcd34d; }
        .status-pub { display: none; } /* å·²å‘å¸ƒä¸æ˜¾ç¤ºæ ‡ç­¾ï¼Œä¿æŒå¹²å‡€ */

        /* --- 6. è¯¦æƒ…é¡µç»„ä»¶ --- */
        .article-footer {
            margin-top: 3rem; padding-top: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        /* ä¼˜é›…çš„ç‚¹èµæŒ‰é’® */
        .like-widget {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 12px;
            background: #f8fafc; border: 1px solid #e2e8f0;
            color: var(--text-light); cursor: pointer; transition: all 0.2s;
            font-weight: 600; user-select: none;
        }
        .like-widget:hover { background: #f1f5f9; }
        .like-widget.active {
            background: #fff1f2; border-color: #fda4af; color: #e11d48;
        }
        .like-widget i { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .like-widget:active i { transform: scale(1.3); }

        /* --- 7. è¡¨å•ç»„ä»¶ --- */
        .form-label { display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-main); font-size: 0.95rem; }
        .form-control {
            width: 100%; padding: 12px 16px;
            border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 1rem; background: #f8fafc;
            transition: all 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; }

        /* åŠ¨ç”»ç±» */
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading { text-align: center; padding: 40px; color: var(--primary); }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="logo" onclick="app.router('home')">
                <i class="fa-solid fa-layer-group"></i> JustDRF
            </div>
            <div id="nav-auth-area"></div>
        </div>
    </nav>

    <main class="main-container">

        <section id="view-login" class="view-section">
            <div class="card" style="max-width: 400px; margin: 4rem auto;">
                <h2 style="text-align: center; margin-bottom: 2rem; font-weight: 800;">æ¬¢è¿å›æ¥</h2>
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div style="margin-bottom: 2rem;">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="login-password" class="form-control" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button onclick="app.login()" class="btn btn-primary" style="width: 100%; justify-content: center;">
                    ç™»å½•è¿›å…¥
                </button>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <span style="color: var(--text-light); font-size: 0.9rem; cursor: pointer;" onclick="app.router('home')">æˆ‘æ˜¯æ¸¸å®¢ï¼Œå…ˆé€›é€› â†’</span>
                </div>
            </div>
        </section>

        <section id="view-home" class="view-section">
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="æœç´¢æ„Ÿå…´è¶£çš„æŠ€æœ¯æ–‡ç« ..." onkeyup="app.handleSearch(this)">
            </div>

            <div id="home-action-area" style="margin-bottom: 2rem; display: none;">
                <button onclick="app.showEditor()" class="btn btn-primary">
                    <i class="fa-solid fa-pen-nib"></i> å†™æ–°æ–‡ç« 
                </button>
            </div>

            <div id="posts-container">
                <div class="loading"><i class="fa-solid fa-spinner fa-spin fa-2x"></i></div>
            </div>
        </section>

        <section id="view-detail" class="view-section">
            <button onclick="app.router('home')" class="btn btn-secondary" style="margin-bottom: 1.5rem;">
                <i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨
            </button>

            <div id="detail-card-container" class="card">
                </div>
        </section>

        <section id="view-editor" class="view-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 id="editor-title-text" style="font-weight: 800;">å‘å¸ƒæ–‡ç« </h2>
                    <button onclick="app.router('home')" style="border:none; background:none; cursor:pointer; font-size:1.2rem; color:#94a3b8;">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <input type="hidden" id="editor-id">
                <div style="margin-bottom: 1.5rem;">
                    <label class="form-label">æ–‡ç« æ ‡é¢˜</label>
                    <input type="text" id="editor-title-input" class="form-control" placeholder="èµ·ä¸ªå“äº®çš„æ ‡é¢˜...">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">æ‰€å±åˆ†ç±»</label>
                        <select id="editor-category" class="form-control"></select>
                    </div>
                    <div>
                        <label class="form-label">æŠ€æœ¯æ ‡ç­¾ (Ctrl/Cmd å¤šé€‰)</label>
                        <select id="editor-tags" class="form-control" multiple style="height: 50px;"></select>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <label class="form-label">æ­£æ–‡å†…å®¹ (Markdown)</label>
                    <textarea id="editor-body" class="form-control" style="min-height: 350px; resize: vertical; line-height: 1.6;" placeholder="å¼€å§‹ä½ çš„åˆ›ä½œ..."></textarea>
                </div>

                <div style="padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 0.9rem;">
                        <i class="fa-solid fa-circle-info"></i> æ”¯æŒ Markdown è¯­æ³•
                    </span>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="app.submitPost('draft')" class="btn btn-secondary">
                            <i class="fa-regular fa-floppy-disk"></i> å­˜ä¸ºè‰ç¨¿
                        </button>
                        <button onclick="app.submitPost('published')" class="btn btn-primary">
                            <i class="fa-solid fa-paper-plane"></i> <span id="publish-btn-text">ç«‹å³å‘å¸ƒ</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section">
            <button onclick="app.router('home')" class="btn btn-secondary" style="margin-bottom: 1.5rem;">
                <i class="fa-solid fa-house"></i> è¿”å›ä¸»é¡µ
            </button>
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <img id="profile-img-preview" src="" style="width: 100px; height: 100px; border-radius: 50%; box-shadow: var(--shadow); object-fit: cover;">
                    <h2 id="profile-username-display" style="margin-top: 1rem;"></h2>
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">å¤´åƒ URL</label>
                    <input type="text" id="profile-avatar-input" class="form-control" oninput="document.getElementById('profile-img-preview').src = this.value">
                </div>
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">ä¸€å¥è¯ç®€ä»‹</label>
                    <textarea id="profile-bio-input" class="form-control"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="email" id="profile-email-input" class="form-control">
                </div>
                <button onclick="app.updateProfile()" class="btn btn-primary" style="width: 100%;">ä¿å­˜ä¸ªäººèµ„æ–™</button>
            </div>
        </section>

    </main>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';

        const app = {
            token: localStorage.getItem('access_token'),
            user: null,

            async init() {
                if (this.token) await this.fetchUser();
                this.renderNav();
                this.router('home');
                this.loadOptions();
            },

            // --- è·¯ç”±ä¸è§†å›¾ ---
            router(viewName) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewName}`).classList.add('active');
                if (viewName === 'home') this.loadPosts();
                if (viewName === 'login' && this.token) this.router('home');
                // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
            },

            // --- API è¯·æ±‚å°è£… ---
            async authFetch(url, options = {}) {
                if (!options.headers) options.headers = {};
                if (!(options.body instanceof FormData)) options.headers['Content-Type'] = 'application/json';
                if (this.token) options.headers['Authorization'] = `Bearer ${this.token}`;
                return fetch(url, options);
            },

            // --- ç”¨æˆ·è®¤è¯ ---
            async login() {
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                try {
                    const res = await fetch(`${API_BASE}/token/login/`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: u, password: p})
                    });
                    if (res.ok) {
                        const data = await res.json();
                        this.token = data.access;
                        localStorage.setItem('access_token', data.access);
                        await this.fetchUser();
                        this.renderNav();
                        this.router('home');
                    } else { alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'); }
                } catch (e) { alert('æ— æ³•è¿æ¥æœåŠ¡å™¨'); }
            },

            logout() {
                this.token = null; this.user = null;
                localStorage.removeItem('access_token');
                this.renderNav(); this.router('home');
            },

            async fetchUser() {
                try {
                    const res = await this.authFetch(`${API_BASE}/users/me/`);
                    if (res.ok) this.user = await res.json(); else this.logout();
                } catch (e) { console.error(e); }
            },

            renderNav() {
                const nav = document.getElementById('nav-auth-area');
                const homeAction = document.getElementById('home-action-area');
                if (this.token && this.user) {
                    if(homeAction) homeAction.style.display = 'block';
                    const avatar = this.user.avatar || `https://ui-avatars.com/api/?name=${this.user.username}&background=4f46e5&color=fff`;
                    nav.innerHTML = `
                        <div style="position: relative;">
                            <div class="user-menu-btn" onclick="document.querySelector('.dropdown').classList.toggle('show')">
                                <img src="${avatar}" class="user-avatar-sm">
                                <span style="font-weight: 600; font-size: 0.9rem; color: #334155;">${this.user.username}</span>
                                <i class="fa-solid fa-angle-down" style="font-size: 0.8rem; color: #94a3b8;"></i>
                            </div>
                            <div class="dropdown">
                                <a class="dropdown-item" onclick="app.showProfile()"><i class="fa-regular fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
                                <div style="border-top: 1px solid #f1f5f9;"></div>
                                <a class="dropdown-item" onclick="app.logout()" style="color: var(--danger);"><i class="fa-solid fa-arrow-right-from-bracket"></i> é€€å‡ºç™»å½•</a>
                            </div>
                        </div>`;
                } else {
                    if(homeAction) homeAction.style.display = 'none';
                    nav.innerHTML = `<button onclick="app.router('login')" class="btn btn-primary" style="padding: 6px 16px;">ç™»å½• / æ³¨å†Œ</button>`;
                }
            },

            // --- ä¸šåŠ¡ï¼šæ–‡ç« åˆ—è¡¨ ---
            async loadPosts(search = '') {
                const container = document.getElementById('posts-container');
                let url = `${API_BASE}/articles/?ordering=-created_at`;
                if(search) url += `&search=${search}`;

                try {
                    const res = await fetch(url); // æ¸¸å®¢ä¹Ÿèƒ½çœ‹
                    const data = await res.json();
                    const posts = data.results || data;

                    if (posts.length === 0) {
                        container.innerHTML = `<div style="text-align:center; padding:3rem; color:#94a3b8;">æš‚æ— ç›¸å…³æ–‡ç«  ğŸƒ</div>`;
                        return;
                    }

                    container.innerHTML = posts.map(post => {
                        const author = post.author || { username: 'æœªçŸ¥', avatar: '' };
                        const avatar = author.avatar || `https://ui-avatars.com/api/?name=${author.username}&background=random`;
                        const categoryName = post.category ? post.category.name : 'æœªåˆ†ç±»';

                        // æ™ºèƒ½è‰ç¨¿æ ‡ç­¾ï¼šå¦‚æœæ˜¯è‰ç¨¿ï¼Œæ˜¾ç¤ºé»„è‰²æ ‡ç­¾
                        const draftBadge = post.status === 'draft'
                            ? `<span class="status-badge status-draft">è‰ç¨¿</span>`
                            : '';

                        return `
                        <div class="post-card" onclick="app.loadDetail(${post.id})">
                            <div style="display:flex; justify-content:space-between; margin-bottom:0.8rem;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <img src="${avatar}" style="width:24px; height:24px; border-radius:50%;">
                                    <span style="font-size:0.85rem; color:#64748b;">${author.username}</span>
                                    <span style="color:#cbd5e1;">|</span>
                                    <span style="font-size:0.85rem; color:var(--primary); font-weight:600;">${categoryName}</span>
                                </div>
                                <span style="font-size:0.8rem; color:#94a3b8;">${new Date(post.created_at).toLocaleDateString()}</span>
                            </div>
                            <h3 style="font-size:1.3rem; font-weight:800; color:#1e293b; margin-bottom:0.5rem; line-height:1.4;">
                                ${draftBadge} ${post.title}
                            </h3>
                            <p style="color:#64748b; font-size:0.95rem; margin-bottom:1.2rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                ${post.summary || 'æš‚æ— æ‘˜è¦'}
                            </p>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    ${(post.tags || []).map(t => `<span class="tag-badge">#${t.name}</span>`).join('')}
                                </div>
                                <div style="display:flex; gap:16px; font-size:0.85rem; color:#94a3b8;">
                                    <span><i class="fa-regular fa-eye"></i> ${post.views}</span>
                                    <span style="color:${post.is_like ? 'var(--danger)' : ''}"><i class="${post.is_like ? 'fa-solid' : 'fa-regular'} fa-heart"></i> ${post.like_count}</span>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } catch (e) { container.innerHTML = `<div style="text-align:center; color:red;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡</div>`; }
            },

            handleSearch(input) { clearTimeout(this.timer); this.timer = setTimeout(() => this.loadPosts(input.value), 500); },

            // --- ä¸šåŠ¡ï¼šæ–‡ç« è¯¦æƒ… ---
            async loadDetail(id) {
                try {
                    const res = await this.authFetch(`${API_BASE}/articles/${id}/`);
                    if(!res.ok) throw new Error("API Error");
                    const post = await res.json();

                    this.router('detail');
                    const isAuthor = this.user && post.author && (this.user.username === post.author.username);
                    const author = post.author || { username: 'æœªçŸ¥', avatar: '' };

                    // æƒé™æ§åˆ¶ï¼šå¦‚æœæ˜¯ä½œè€…ï¼Œæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤
                    const actionBtns = isAuthor ? `
                        <div style="display:flex; gap:10px; margin-top:2rem; padding-top:1rem; border-top:1px solid #eee;">
                            <button onclick='app.showEditor(${JSON.stringify(post).replace(/'/g, "&#39;")})' class="btn btn-secondary">
                                <i class="fa-solid fa-pen-to-square"></i> ç¼–è¾‘
                            </button>
                            <button onclick="app.deletePost(${post.id})" class="btn btn-danger">
                                <i class="fa-regular fa-trash-can"></i> åˆ é™¤
                            </button>
                        </div>` : '';

                    document.getElementById('detail-card-container').innerHTML = `
                        <div style="margin-bottom:1.5rem;">
                            <h1 style="font-size:2rem; font-weight:800; color:#1e293b; line-height:1.3; margin-bottom:1rem;">
                                ${post.status === 'draft' ? '<span class="status-badge status-draft" style="font-size:1rem; vertical-align:text-bottom;">è‰ç¨¿</span>' : ''}
                                ${post.title}
                            </h1>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <img src="${author.avatar || 'https://ui-avatars.com/api/?name='+author.username}" style="width:40px; height:40px; border-radius:50%;">
                                <div>
                                    <div style="font-weight:700; color:#334155;">${author.username}</div>
                                    <div style="font-size:0.85rem; color:#94a3b8;">å‘å¸ƒäº ${new Date(post.created_at).toLocaleString()}</div>
                                </div>
                                <span style="margin-left:auto; background:#f1f5f9; padding:4px 12px; border-radius:8px; font-size:0.9rem; color:#64748b;">
                                    ${post.category?.name || 'æœªåˆ†ç±»'}
                                </span>
                            </div>
                        </div>

                        <div style="font-size:1.1rem; line-height:1.8; color:#334155; white-space: pre-wrap;">${post.body}</div>

                        <div class="article-footer">
                            <div style="display:flex; gap:8px;">
                                ${(post.tags||[]).map(t => `<span class="tag-badge">#${t.name}</span>`).join('')}
                            </div>
                            <div style="display:flex; align-items:center; gap:20px;">
                                <span style="color:#94a3b8; font-size:0.9rem;"><i class="fa-regular fa-eye"></i> ${post.views} é˜…è¯»</span>
                                <div onclick="app.toggleLike(${post.id})" class="like-widget ${post.is_like ? 'active' : ''}" id="like-btn-detail">
                                    <i class="${post.is_like ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                                    <span>${post.is_like ? 'å·²èµ' : 'ç‚¹èµ'}</span>
                                    <span id="like-count-detail" style="margin-left:4px;">${post.like_count}</span>
                                </div>
                            </div>
                        </div>
                        ${actionBtns}
                    `;
                } catch (e) { alert("åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥"); }
            },

            async toggleLike(id) {
                if(!this.token) return alert('è¯·å…ˆç™»å½•åç‚¹èµï¼');
                try {
                    const res = await this.authFetch(`${API_BASE}/articles/${id}/like/`, { method: 'POST' });
                    const data = await res.json();

                    const btn = document.getElementById('like-btn-detail');
                    const countSpan = document.getElementById('like-count-detail');
                    const icon = btn.querySelector('i');
                    const text = btn.querySelector('span:nth-child(2)');
                    let count = parseInt(countSpan.innerText);

                    if (data.message.includes('æˆåŠŸ')) {
                        btn.classList.add('active');
                        icon.classList.replace('fa-regular', 'fa-solid');
                        text.innerText = 'å·²èµ';
                        countSpan.innerText = count + 1;
                    } else {
                        btn.classList.remove('active');
                        icon.classList.replace('fa-solid', 'fa-regular');
                        text.innerText = 'ç‚¹èµ';
                        countSpan.innerText = count - 1;
                    }
                } catch(e) { alert('æ“ä½œå¤±è´¥'); }
            },

            // --- ä¸šåŠ¡ï¼šç¼–è¾‘å™¨ (æ ¸å¿ƒæ”¹åŠ¨) ---
            async loadOptions() {
                try {
                    const res = await fetch(`${API_BASE}/categories/`);
                    const data = await res.json();
                    document.getElementById('editor-category').innerHTML = (data.results||data).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                } catch(e){}
                // æ¨¡æ‹Ÿæ ‡ç­¾æ•°æ®
                document.getElementById('editor-tags').innerHTML = `<option value="1">Python</option><option value="2">Django</option><option value="3">DRF</option><option value="4">Vue.js</option>`;
            },

            showEditor(post = null) {
                this.router('editor');
                const btnText = document.getElementById('publish-btn-text');

                if (post) {
                    document.getElementById('editor-title-text').innerText = "ç¼–è¾‘æ–‡ç« ";
                    document.getElementById('editor-id').value = post.id;
                    document.getElementById('editor-title-input').value = post.title;
                    document.getElementById('editor-body').value = post.body;
                    document.getElementById('editor-category').value = post.category?.id;

                    // æ™ºèƒ½æŒ‰é’®æ–‡æ¡ˆ
                    if (post.status === 'published') {
                        btnText.innerText = "æ›´æ–°å†…å®¹";
                    } else {
                        btnText.innerText = "å‘å¸ƒæ–‡ç« "; // æ˜¯è‰ç¨¿ï¼Œæ‰€ä»¥åŠ¨ä½œæ˜¯å‘å¸ƒ
                    }
                } else {
                    document.getElementById('editor-title-text').innerText = "å‘å¸ƒæ–°æ–‡ç« ";
                    document.getElementById('editor-id').value = '';
                    document.getElementById('editor-title-input').value = '';
                    document.getElementById('editor-body').value = '';
                    btnText.innerText = "ç«‹å³å‘å¸ƒ";
                }
            },

            async submitPost(targetStatus) {
                const id = document.getElementById('editor-id').value;
                const title = document.getElementById('editor-title-input').value;
                const body = document.getElementById('editor-body').value;
                const category = document.getElementById('editor-category').value;
                const tags_ids = Array.from(document.getElementById('editor-tags').selectedOptions).map(o => o.value);

                if(!title || !body) return alert("æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©º");

                const payload = {
                    title, body, category, tags_ids,
                    status: targetStatus // æ ¸å¿ƒï¼šæŠŠ draft æˆ– published ä¼ ç»™åç«¯
                };

                const method = id ? 'PATCH' : 'POST';
                const url = id ? `${API_BASE}/articles/${id}/` : `${API_BASE}/articles/`;

                try {
                    const res = await this.authFetch(url, { method, body: JSON.stringify(payload) });
                    if(res.ok) {
                        if (targetStatus === 'draft') alert('âœ… å·²å­˜ä¸ºè‰ç¨¿');
                        else alert('ğŸš€ å‘å¸ƒæˆåŠŸ');
                        this.router('home');
                    } else { alert('æäº¤å¤±è´¥'); }
                } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
            },

            async deletePost(id) {
                if(confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    const res = await this.authFetch(`${API_BASE}/articles/${id}/`, { method: 'DELETE' });
                    if(res.ok) { alert('å·²åˆ é™¤'); this.router('home'); }
                }
            },

            // --- ä¸šåŠ¡ï¼šä¸ªäººä¸­å¿ƒ ---
            showProfile() {
                this.router('profile');
                if(this.user) {
                    document.getElementById('profile-username-display').innerText = this.user.username;
                    document.getElementById('profile-avatar-input').value = this.user.avatar || '';
                    document.getElementById('profile-img-preview').src = this.user.avatar || '';
                    document.getElementById('profile-bio-input').value = this.user.bio || '';
                    document.getElementById('profile-email-input').value = this.user.email || '';
                }
            },
            async updateProfile() {
                const payload = {
                    avatar: document.getElementById('profile-avatar-input').value,
                    bio: document.getElementById('profile-bio-input').value,
                    email: document.getElementById('profile-email-input').value
                };
                const res = await this.authFetch(`${API_BASE}/users/me/`, { method: 'PATCH', body: JSON.stringify(payload) });
                if(res.ok) { alert('ä¿å­˜æˆåŠŸ'); await this.fetchUser(); this.renderNav(); } else { alert('ä¿å­˜å¤±è´¥'); }
            }
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => app.init());

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        window.onclick = function(e) {
            if (!e.target.closest('.user-menu-btn')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
            }
        }
    </script>
</body>
</html>