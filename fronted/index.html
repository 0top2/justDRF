<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JustDRF | æå®¢ç©ºé—´</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. æ ¸å¿ƒè®¾è®¡ç³»ç»Ÿ (Glassmorphism) --- */
        :root {
            /* å“ç‰Œè‰²ï¼šæ›´æå®¢çš„è“ç´«è‰² */
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --accent: #f43f5e; /* å¼ºè°ƒè‰²ï¼Œç”¨äºç‚¹èµ/åˆ é™¤ */

            /* æ–‡å­—é¢œè‰² */
            --text-main: #1e293b;
            --text-secondary: #475569;
            --text-light: #94a3b8;

            /* ç»ç’ƒè´¨æ„Ÿå˜é‡ */
            --glass-bg: rgba(255, 255, 255, 0.7); /* èƒŒæ™¯é€æ˜åº¦ */
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --blur: blur(16px);

            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            color: var(--text-main);
            line-height: 1.7;
            min-height: 100vh;
            /* åŠ¨æ€èƒŒæ™¯ */
            background-color: #f8fafc;
            background-image:
                radial-gradient(at 40% 20%, hsla(250,100%,94%,1) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,100%,96%,1) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(341,100%,96%,1) 0px, transparent 50%),
                radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 30px 30px;
            background-attachment: fixed;
        }

        /* é€šç”¨ç»ç’ƒå¡ç‰‡ç±» */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* --- 2. å¯¼èˆªæ  --- */
        .navbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
            padding: 0.8rem 0;
        }
        .nav-inner {
            max-width: 1100px; margin: 0 auto; padding: 0 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo-area { display: flex; align-items: center; gap: 2rem; }
        .logo {
            font-size: 1.5rem; font-weight: 800; color: var(--primary);
            cursor: pointer; letter-spacing: -1px;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-links { display: flex; gap: 20px; display: none; }
        @media(min-width: 768px) { .nav-links { display: flex; } }

        .nav-item {
            color: var(--text-secondary); font-size: 0.95rem; font-weight: 500;
            cursor: pointer; position: relative; padding: 5px 0; transition: color 0.2s;
        }
        .nav-item:hover { color: var(--primary); }

        /* ç”¨æˆ·èœå• */
        .user-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 12px; border-radius: 30px;
            background: rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.8);
            cursor: pointer; transition: all 0.2s;
        }
        .user-btn:hover { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }

        .dropdown-menu {
            position: absolute; top: 50px; right: 0; width: 160px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 8px 0;
            display: none; animation: slideIn 0.2s ease;
            transform-origin: top right;
        }
        .dropdown-menu.show { display: block; }
        .menu-item {
            padding: 10px 20px; display: block; color: var(--text-main);
            cursor: pointer; font-size: 0.9rem; transition: background 0.2s;
        }
        .menu-item:hover { background: #f1f5f9; color: var(--primary); }

        /* --- 3. å¸ƒå±€å®¹å™¨ --- */
        .container {
            max-width: 900px; margin: 2.5rem auto; padding: 0 1.5rem;
            animation: fadeIn 0.5s ease;
        }
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- 4. é¦–é¡µåˆ—è¡¨ --- */
        .search-box { position: relative; margin-bottom: 2.5rem; }
        .search-input {
            width: 100%; padding: 18px 25px 18px 50px;
            border-radius: 16px; border: none;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            font-size: 1rem; color: var(--text-main);
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.3s;
        }
        .search-input:focus {
            background: white; outline: none;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
        }
        .search-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: var(--text-light); }

        .post-card {
            padding: 2rem; margin-bottom: 2rem;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .post-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        }
        .post-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(to bottom, var(--primary), #a5b4fc);
            opacity: 0; transition: opacity 0.3s;
        }
        .post-card:hover::before { opacity: 1; }

        .card-meta { display: flex; gap: 15px; font-size: 0.85rem; color: var(--text-light); margin-bottom: 10px; align-items: center; }
        .category-tag { background: rgba(99, 102, 241, 0.1); color: var(--primary); padding: 2px 8px; border-radius: 6px; font-weight: 600; }
        .post-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; line-height: 1.4; }
        .post-summary { color: var(--text-secondary); margin-bottom: 1.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* --- 5. è¯¦æƒ…é¡µ & è¯„è®ºåŒº (æ ¸å¿ƒä¿®æ”¹) --- */
        .detail-container { padding: 3rem; position: relative; }

        .detail-header { text-align: center; margin-bottom: 3rem; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 2rem; }
        .detail-title { font-size: 2.2rem; font-weight: 800; margin-bottom: 1.5rem; line-height: 1.3; color: #1e293b; }
        .detail-info { display: flex; justify-content: center; align-items: center; gap: 20px; color: var(--text-secondary); font-size: 0.95rem; }
        .detail-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .article-content { font-size: 1.1rem; line-height: 1.8; color: #334155; margin-bottom: 4rem; white-space: pre-wrap; }

        /* è¯„è®ºåŒºç›–æ¥¼æ ·å¼ */
        .comments-section { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(0,0,0,0.06); }
        .comment-box { margin-bottom: 3rem; display: flex; gap: 15px; }
        .comment-input-area { flex: 1; }
        .comment-textarea {
            width: 100%; height: 80px; padding: 15px;
            border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.5); resize: none;
            transition: all 0.2s; font-family: inherit;
        }
        .comment-textarea:focus { background: white; border-color: var(--primary); outline: none; height: 120px; }

        /* è¯„è®ºæ ‘ç»“æ„ */
        .comment-node { margin-bottom: 15px; position: relative; }
        /* è¯„è®ºå¡ç‰‡ä¸»ä½“ */
        .comment-item {
            display: flex; gap: 15px; padding: 15px;
            border-radius: 12px; transition: background 0.2s;
            position: relative;
        }
        .comment-item:hover { background: rgba(255,255,255,0.6); }

        /* æ ¸å¿ƒï¼šå­è¯„è®ºç¼©è¿› (ç›–æ¥¼æ•ˆæœ) */
        .comment-children {
            margin-left: 35px; /* ç¼©è¿› */
            padding-left: 15px;
            border-left: 2px solid rgba(99, 102, 241, 0.15); /* è¿æ¥çº¿ */
            margin-top: 5px;
        }

        .c-avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; }
        .c-content { flex: 1; }
        .c-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; font-size: 0.9rem; }
        .c-name { font-weight: 700; color: var(--text-main); }
        .c-time { color: var(--text-light); font-size: 0.8rem; }
        .c-body { color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; margin-bottom: 8px; }
        .c-actions { display: flex; gap: 15px; font-size: 0.85rem; opacity: 0.8; transition: opacity 0.2s; }
        .comment-item:hover .c-actions { opacity: 1; }
        .btn-text { cursor: pointer; color: var(--text-light); font-weight: 500; display: inline-flex; align-items: center; gap: 4px; }
        .btn-text:hover { color: var(--primary); }
        .btn-text.delete:hover { color: var(--accent); }

        /* é†’ç›®çš„å›å¤æ ‡ç­¾ */
        .reply-badge {
            display: inline-flex; align-items: center; gap: 4px;
            color: var(--primary); font-weight: 600; font-size: 0.9rem;
            margin-right: 6px;
            background: rgba(99, 102, 241, 0.08); padding: 0 6px; border-radius: 4px;
        }
        .reply-arrow { font-size: 0.75rem; opacity: 0.6; }

        /* --- 6. æŒ‰é’®ç»„ä»¶ --- */
        .btn {
            border: none; padding: 10px 20px; border-radius: 10px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid rgba(0,0,0,0.1); }
        .btn-ghost:hover { border-color: var(--primary); color: var(--primary); background: white; }

        /* --- 7. ç™»å½•é¡µ & ç¼–è¾‘å™¨ --- */
        .auth-card { max-width: 400px; margin: 4rem auto; padding: 3rem !important; text-align: center; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-control {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.5);
        }
        .form-control:focus { background: white; border-color: var(--primary); outline: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .like-btn.active { color: var(--accent); }
        .like-btn.active i { animation: beat 0.3s ease; }
        @keyframes beat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-inner">
            <div class="logo-area">
                <div class="logo" onclick="app.router('home')">
                    <i class="fa-solid fa-layer-group"></i> JustDRF
                </div>
                <div class="nav-links">
                    <span class="nav-item" onclick="app.router('home')">é¦–é¡µ</span>
                    <span class="nav-item" onclick="alert('åˆ†ç±»åŠŸèƒ½å¼€å‘ä¸­...')">ä¸“æ </span>
                    <span class="nav-item" onclick="alert('æ ‡ç­¾åŠŸèƒ½å¼€å‘ä¸­...')">è¯é¢˜</span>
                    <span class="nav-item" onclick="window.open('https://github.com/0top2/justdrf')">GitHub</span>
                </div>
            </div>
            <div id="nav-auth-area"></div>
        </div>
    </nav>

    <main class="container">

        <section id="view-login" class="view-section">
            <div class="glass-card auth-card">
                <h2 style="font-size: 1.8rem; margin-bottom: 2rem;">æ¬¢è¿å›æ¥</h2>
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" id="login-username" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" id="login-password" class="form-control" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button onclick="app.login()" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;">
                    ç«‹å³ç™»å½•
                </button>
                <div style="margin-top: 1.5rem;">
                    <span style="color: var(--text-light); font-size: 0.9rem; cursor: pointer;" onclick="app.router('home')">æš‚ä¸ç™»å½•ï¼Œéšä¾¿é€›é€› â†’</span>
                </div>
            </div>
        </section>

        <section id="view-home" class="view-section">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜..." onkeyup="app.handleSearch(this)">
            </div>

            <div id="home-action-area" style="margin-bottom: 2rem; display: none; text-align: right;">
                <button onclick="app.showEditor()" class="btn btn-primary">
                    <i class="fa-solid fa-pen-nib"></i> å†™æ–°æ–‡ç« 
                </button>
            </div>

            <div id="posts-container">
                <div style="text-align: center; color: var(--text-light); padding: 4rem;">
                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                </div>
            </div>
        </section>

        <section id="view-detail" class="view-section">
            <div class="glass-card detail-container">
                <div style="position: absolute; top: 20px; left: 20px;">
                    <button onclick="app.router('home')" class="btn btn-ghost" style="padding: 8px 12px;">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>
                </div>

                <div class="detail-header">
                    <h1 id="d-title" class="detail-title">...</h1>
                    <div class="detail-info">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img id="d-avatar" src="" class="detail-avatar">
                            <span id="d-author" style="font-weight: 600; color: var(--text-main);">ä½œè€…</span>
                        </div>
                        <span>â€¢</span>
                        <span id="d-date">æ—¶é—´</span>
                        <span>â€¢</span>
                        <span id="d-views">0 é˜…è¯»</span>
                    </div>
                </div>

                <div id="d-body" class="article-content"></div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div id="d-tags" style="display: flex; gap: 10px;"></div>
                    <button id="d-like-btn" class="btn btn-ghost like-btn" onclick="app.toggleLike()">
                        <i class="fa-regular fa-heart"></i> <span id="d-like-count">0</span>
                    </button>
                </div>

                <div id="d-owner-actions" style="display: none; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 1rem; justify-content: flex-end; gap: 10px;">
                    <button onclick="app.editCurrentPost()" class="btn btn-ghost"><i class="fa-solid fa-pen"></i> ç¼–è¾‘</button>
                    <button onclick="app.deleteCurrentPost()" class="btn btn-ghost" style="color: var(--accent);"><i class="fa-regular fa-trash-can"></i> åˆ é™¤</button>
                </div>

                <div class="comments-section">
                    <h3 style="margin-bottom: 1.5rem; font-weight: 700;">è¯„è®º <span id="c-count" style="font-size: 1rem; color: var(--text-light); font-weight: 400;">(0)</span></h3>

                    <div class="comment-box" id="comment-form-container">
                        <img id="my-avatar-comment" src="" class="c-avatar" style="display: none;">
                        <div class="comment-input-area">
                            <textarea id="comment-input" class="comment-textarea" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                <span id="reply-tag-display" style="font-size: 0.85rem; color: var(--primary); display: none;">
                                    <i class="fa-solid fa-reply"></i> å›å¤ @<span id="reply-tag-name"></span> <i class="fa-solid fa-xmark" style="cursor: pointer;" onclick="app.cancelReply()"></i>
                                </span>
                                <button onclick="app.submitComment()" class="btn btn-primary" style="padding: 6px 16px; font-size: 0.9rem;">
                                    å‘é€è¯„è®º
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="comments-list">
                        </div>
                </div>

            </div>
        </section>

        <section id="view-editor" class="view-section">
            <div class="glass-card detail-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h2 id="editor-heading">å‘å¸ƒæ–‡ç« </h2>
                    <button onclick="app.router('home')" class="btn btn-ghost"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <input type="hidden" id="editor-id">
                <div class="form-group">
                    <input type="text" id="editor-title" class="form-control" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" style="font-size: 1.2rem; font-weight: 700; padding: 15px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 1.5rem;">
                    <div>
                        <label class="form-label">åˆ†ç±»</label>
                        <select id="editor-category" class="form-control"></select>
                    </div>
                    <div>
                        <label class="form-label">æ ‡ç­¾</label>
                        <select id="editor-tags" class="form-control" multiple></select>
                    </div>
                </div>
                <div class="form-group">
                    <textarea id="editor-body" class="form-control" style="min-height: 400px; line-height: 1.6; resize: vertical;" placeholder="æ”¯æŒ Markdown..."></textarea>
                </div>
                <div style="text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="app.savePost('draft')" class="btn btn-ghost">å­˜è‰ç¨¿</button>
                    <button onclick="app.savePost('published')" class="btn btn-primary">å‘å¸ƒæ–‡ç« </button>
                </div>
            </div>
        </section>

        <section id="view-profile" class="view-section">
            <div class="glass-card auth-card" style="max-width: 600px;">
                <h2 style="margin-bottom: 2rem;">ç¼–è¾‘èµ„æ–™</h2>
                <div style="text-align: center; margin-bottom: 2rem;">
                    <img id="p-avatar-preview" src="" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;">
                </div>
                <div class="form-group">
                    <label class="form-label">å¤´åƒé“¾æ¥</label>
                    <input type="text" id="p-avatar" class="form-control" oninput="document.getElementById('p-avatar-preview').src = this.value">
                </div>
                <div class="form-group">
                    <label class="form-label">ç®€ä»‹</label>
                    <textarea id="p-bio" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">é‚®ç®±</label>
                    <input type="text" id="p-email" class="form-control">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="app.router('home')" class="btn btn-ghost" style="flex: 1;">å–æ¶ˆ</button>
                    <button onclick="app.updateProfile()" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                </div>
            </div>
        </section>

    </main>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';

        const app = {
            token: localStorage.getItem('access_token'),
            user: null,
            currentPost: null,
            replyParentId: null,

            async init() {
                if (this.token) await this.fetchUser();
                this.renderNav();
                this.router('home');
                this.loadOptions();
            },

            async req(url, method = 'GET', data = null) {
                const headers = { 'Content-Type': 'application/json' };
                if (this.token) headers['Authorization'] = `Bearer ${this.token}`;
                const config = { method, headers };
                if (data) config.body = JSON.stringify(data);

                try {
                    const res = await fetch(url, config);
                    if (res.status === 401) { this.logout(); return null; }
                    return res;
                } catch(e) { console.error(e); alert('ç½‘ç»œè¯·æ±‚å¤±è´¥'); return null; }
            },

            // --- è·¯ç”± ---
            router(view) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${view}`).classList.add('active');
                window.scrollTo(0, 0);
                if (view === 'home') this.loadPosts();
                const menu = document.querySelector('.dropdown-menu');
                if(menu) menu.classList.remove('show');
            },

            renderNav() {
                const navAuth = document.getElementById('nav-auth-area');
                const homeAction = document.getElementById('home-action-area');

                if (this.user) {
                    if(homeAction) homeAction.style.display = 'block';
                    const avatar = this.user.avatar || `https://ui-avatars.com/api/?name=${this.user.username}&background=6366f1&color=fff`;
                    navAuth.innerHTML = `
                        <div style="position: relative;">
                            <div class="user-btn" onclick="document.querySelector('.dropdown-menu').classList.toggle('show')">
                                <img src="${avatar}" class="user-avatar">
                                <span style="font-weight: 600; font-size: 0.9rem;">${this.user.username}</span>
                                <i class="fa-solid fa-angle-down" style="font-size: 0.8rem; color: #64748b;"></i>
                            </div>
                            <div class="dropdown-menu">
                                <a class="menu-item" onclick="app.editProfile()"><i class="fa-regular fa-user"></i> ä¸ªäººèµ„æ–™</a>
                                <a class="menu-item" onclick="app.logout()" style="color: var(--accent);"><i class="fa-solid fa-arrow-right-from-bracket"></i> é€€å‡ºç™»å½•</a>
                            </div>
                        </div>
                    `;
                    const cAvatar = document.getElementById('my-avatar-comment');
                    if(cAvatar) { cAvatar.src = avatar; cAvatar.style.display = 'block'; }
                } else {
                    if(homeAction) homeAction.style.display = 'none';
                    navAuth.innerHTML = `<button onclick="app.router('login')" class="btn btn-primary" style="padding: 6px 16px;">ç™»å½• / æ³¨å†Œ</button>`;
                    const cAvatar = document.getElementById('my-avatar-comment');
                    if(cAvatar) cAvatar.style.display = 'none';
                }
            },

            // --- Auth ---
            async login() {
                const u = document.getElementById('login-username').value;
                const p = document.getElementById('login-password').value;
                const res = await fetch(`${API_BASE}/token/login/`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: u, password: p})
                });
                if (res.ok) {
                    const data = await res.json();
                    this.token = data.access;
                    localStorage.setItem('access_token', data.access);
                    await this.fetchUser();
                    this.renderNav();
                    this.router('home');
                } else { alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'); }
            },
            logout() {
                this.token = null; this.user = null;
                localStorage.removeItem('access_token');
                this.renderNav();
                this.router('home');
            },
            async fetchUser() {
                const res = await this.req(`${API_BASE}/users/me/`);
                if (res && res.ok) this.user = await res.json();
            },

            // --- é¦–é¡µ ---
            async loadPosts(search = '') {
                const container = document.getElementById('posts-container');
                let url = `${API_BASE}/articles/?ordering=-created_at`;
                if(search) url += `&search=${search}`;

                const res = await this.req(url);
                const data = await res.json();
                const posts = data.results || data;

                if (posts.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-light);">æš‚æ— æ–‡ç«  ğŸƒ</div>`;
                    return;
                }

                container.innerHTML = posts.map(post => {
                    const authorName = post.author?.username || 'åŒ¿å';
                    const catName = post.category?.name || 'æœªåˆ†ç±»';
                    return `
                    <div class="glass-card post-card" onclick="app.openDetail(${post.id})">
                        <div class="card-meta">
                            <span class="category-tag">${catName}</span>
                            <span>${authorName}</span>
                            <span>â€¢</span>
                            <span>${new Date(post.created_at).toLocaleDateString()}</span>
                            ${post.status === 'draft' ? '<span style="color:#f59e0b; font-weight:bold;">(è‰ç¨¿)</span>' : ''}
                        </div>
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-summary">${post.summary || 'æš‚æ— æ‘˜è¦'}</p>
                        <div style="display:flex; justify-content:space-between; color:var(--text-light); font-size:0.85rem;">
                            <div>${(post.tags||[]).map(t => `#${t.name}`).join(' ')}</div>
                            <div style="display:flex; gap:15px;">
                                <span><i class="fa-regular fa-eye"></i> ${post.views}</span>
                                <span style="${post.is_like ? 'color:var(--accent)' : ''}"><i class="${post.is_like ? 'fa-solid' : 'fa-regular'} fa-heart"></i> ${post.like_count}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
            handleSearch(input) { clearTimeout(this.timer); this.timer = setTimeout(() => this.loadPosts(input.value), 500); },

            // --- è¯¦æƒ… & è¯„è®º (æ ¸å¿ƒ) ---
            async openDetail(id) {
                const res = await this.req(`${API_BASE}/articles/${id}/`);
                if(!res.ok) return alert('æ–‡ç« åŠ è½½å¤±è´¥');

                const post = await res.json();
                this.currentPost = post;
                this.router('detail');

                document.getElementById('d-title').innerText = post.title;
                document.getElementById('d-author').innerText = post.author?.username;
                document.getElementById('d-avatar').src = post.author?.avatar || `https://ui-avatars.com/api/?name=${post.author?.username}`;
                document.getElementById('d-date').innerText = new Date(post.created_at).toLocaleString();
                document.getElementById('d-views').innerText = `${post.views} é˜…è¯»`;
                document.getElementById('d-body').innerText = post.body;

                document.getElementById('d-tags').innerHTML = (post.tags||[]).map(t =>
                    `<span class="category-tag" style="background:rgba(0,0,0,0.05); color:var(--text-secondary);">#${t.name}</span>`
                ).join('');

                const likeBtn = document.getElementById('d-like-btn');
                document.getElementById('d-like-count').innerText = post.like_count;
                if(post.is_like) {
                    likeBtn.classList.add('active');
                    likeBtn.querySelector('i').className = 'fa-solid fa-heart';
                } else {
                    likeBtn.classList.remove('active');
                    likeBtn.querySelector('i').className = 'fa-regular fa-heart';
                }

                const isOwner = this.user && post.author && (this.user.username === post.author.username);
                document.getElementById('d-owner-actions').style.display = isOwner ? 'flex' : 'none';

                // æ¸²æŸ“æ ‘çŠ¶è¯„è®º
                this.renderCommentsTree(post.comments || []);
                this.cancelReply();
            },

            // --- é€’å½’æ„å»ºè¯„è®ºæ ‘ (æ ¸å¿ƒç®—æ³•) ---
            buildCommentTree(comments) {
                const map = {};
                const roots = [];
                // 1. åˆå§‹åŒ– Map
                comments.forEach(c => {
                    c.children = [];
                    map[c.id] = c;
                });
                // 2. ç»„è£…æ ‘
                comments.forEach(c => {
                    if (c.parent && map[c.parent]) {
                        map[c.parent].children.push(c);
                    } else {
                        roots.push(c);
                    }
                });
                return roots;
            },

            renderCommentsTree(flatComments) {
                document.getElementById('c-count').innerText = `(${flatComments.length})`;
                const listEl = document.getElementById('comments-list');

                if(!flatComments || flatComments.length === 0) {
                    listEl.innerHTML = `<div style="text-align:center; color:var(--text-light); padding:20px;">æš‚æ— è¯„è®ºï¼Œæ¥åšç¬¬ä¸€ä¸ªå‘è¨€çš„äººå§ï¼</div>`;
                    return;
                }

                // 1. è½¬æ ‘
                const tree = this.buildCommentTree(flatComments);

                // 2. é€’å½’æ¸²æŸ“ HTML
                const renderNode = (node) => {
                    const avatar = node.author?.avatar || `https://ui-avatars.com/api/?name=${node.author?.username}`;
                    const isMyComment = this.user && node.author?.username === this.user.username;

                    // æ ¸å¿ƒï¼šæ˜ç¡®çš„å›å¤æ ‡ç­¾ "å›å¤ @å¼ ä¸‰"
                    let replyBadge = '';
                    if (node.reply_to_author) {
                        replyBadge = `<span class="reply-badge">å›å¤ <i class="fa-solid fa-caret-right reply-arrow"></i> ${node.reply_to_author}</span>`;
                    }

                    // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
                    let childrenHtml = '';
                    if (node.children && node.children.length > 0) {
                        childrenHtml = `<div class="comment-children">${node.children.map(renderNode).join('')}</div>`;
                    }

                    return `
                    <div class="comment-node" id="comment-${node.id}">
                        <div class="comment-item">
                            <img src="${avatar}" class="c-avatar">
                            <div class="c-content">
                                <div class="c-header">
                                    <span class="c-name">${node.author?.username}</span>
                                    <span class="c-time">${new Date(node.created_at).toLocaleString()}</span>
                                </div>
                                <div class="c-body">
                                    ${replyBadge}${node.body}
                                </div>
                                <div class="c-actions">
                                    <span class="btn-text" onclick="app.setReply(${node.id}, '${node.author?.username}')">
                                        <i class="fa-solid fa-reply"></i> å›å¤
                                    </span>
                                    ${isMyComment ? `<span class="btn-text delete" onclick="app.deleteComment(${node.id})"><i class="fa-regular fa-trash-can"></i> åˆ é™¤</span>` : ''}
                                </div>
                            </div>
                        </div>
                        ${childrenHtml} </div>`;
                };

                listEl.innerHTML = tree.map(renderNode).join('');
            },

            setReply(commentId, username) {
                this.replyParentId = commentId;
                document.getElementById('reply-tag-display').style.display = 'inline-block';
                document.getElementById('reply-tag-name').innerText = username;
                document.getElementById('comment-input').focus();
            },
            cancelReply() {
                this.replyParentId = null;
                document.getElementById('reply-tag-display').style.display = 'none';
            },
            async submitComment() {
                if(!this.user) return alert('è¯·å…ˆç™»å½•');
                const body = document.getElementById('comment-input').value;
                if(!body.trim()) return alert('å†™ç‚¹å†…å®¹å§');

                const payload = {
                    post: this.currentPost.id,
                    body: body,
                    parent: this.replyParentId
                };

                const res = await this.req(`${API_BASE}/comments/`, 'POST', payload);
                if(res.ok) {
                    document.getElementById('comment-input').value = '';
                    this.cancelReply();
                    await this.openDetail(this.currentPost.id);
                } else {
                    alert('è¯„è®ºå¤±è´¥');
                }
            },
            async deleteComment(id) {
                if(!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
                const res = await this.req(`${API_BASE}/comments/${id}/`, 'DELETE');
                if(res.ok) await this.openDetail(this.currentPost.id);
            },
            async toggleLike() {
                if(!this.user) return alert('è¯·å…ˆç™»å½•');
                const res = await this.req(`${API_BASE}/articles/${this.currentPost.id}/like/`, 'POST');
                const data = await res.json();
                const likeBtn = document.getElementById('d-like-btn');
                const countSpan = document.getElementById('d-like-count');
                let count = parseInt(countSpan.innerText);

                if(data.message.includes('æˆåŠŸ')) {
                    likeBtn.classList.add('active');
                    likeBtn.querySelector('i').className = 'fa-solid fa-heart';
                    countSpan.innerText = count + 1;
                } else {
                    likeBtn.classList.remove('active');
                    likeBtn.querySelector('i').className = 'fa-regular fa-heart';
                    countSpan.innerText = count - 1;
                }
            },

            // --- ç¼–è¾‘å™¨ ---
            showEditor() {
                this.currentPost = null;
                this.router('editor');
                document.getElementById('editor-heading').innerText = 'å‘å¸ƒæ–°æ–‡ç« ';
                document.getElementById('editor-id').value = '';
                document.getElementById('editor-title').value = '';
                document.getElementById('editor-body').value = '';
                this.loadOptions();
            },
            editCurrentPost() {
                const p = this.currentPost;
                this.router('editor');
                document.getElementById('editor-heading').innerText = 'ç¼–è¾‘æ–‡ç« ';
                document.getElementById('editor-id').value = p.id;
                document.getElementById('editor-title').value = p.title;
                document.getElementById('editor-body').value = p.body;
                document.getElementById('editor-category').value = p.category?.id;
            },
            async savePost(status) {
                const id = document.getElementById('editor-id').value;
                const payload = {
                    title: document.getElementById('editor-title').value,
                    body: document.getElementById('editor-body').value,
                    category: document.getElementById('editor-category').value,
                    tags_ids: Array.from(document.getElementById('editor-tags').selectedOptions).map(o=>o.value),
                    status: status
                };

                const url = id ? `${API_BASE}/articles/${id}/` : `${API_BASE}/articles/`;
                const method = id ? 'PATCH' : 'POST';
                const res = await this.req(url, method, payload);
                if(res.ok) { alert('ä¿å­˜æˆåŠŸ'); this.router('home'); }
                else alert('ä¿å­˜å¤±è´¥');
            },
            async deleteCurrentPost() {
                if(!confirm('ç¡®å®šåˆ é™¤æ•´ç¯‡æ–‡ç« å—ï¼Ÿ')) return;
                const res = await this.req(`${API_BASE}/articles/${this.currentPost.id}/`, 'DELETE');
                if(res.ok) { alert('å·²åˆ é™¤'); this.router('home'); }
            },

            async loadOptions() {
                try {
                    const res = await fetch(`${API_BASE}/categories/`);
                    const data = await res.json();
                    document.getElementById('editor-category').innerHTML = (data.results||data).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                } catch(e){}
                document.getElementById('editor-tags').innerHTML = `<option value="1">Python</option><option value="2">Django</option><option value="3">Frontend</option>`;
            },

            editProfile() {
                this.router('profile');
                if(this.user) {
                    document.getElementById('p-avatar').value = this.user.avatar || '';
                    document.getElementById('p-avatar-preview').src = this.user.avatar || '';
                    document.getElementById('p-bio').value = this.user.bio || '';
                    document.getElementById('p-email').value = this.user.email || '';
                }
            },
            async updateProfile() {
                const payload = {
                    avatar: document.getElementById('p-avatar').value,
                    bio: document.getElementById('p-bio').value,
                    email: document.getElementById('p-email').value
                };
                const res = await this.req(`${API_BASE}/users/me/`, 'PATCH', payload);
                if(res.ok) { alert('ä¿å­˜æˆåŠŸ'); await this.fetchUser(); this.router('home'); }
                else alert('ä¿å­˜å¤±è´¥');
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
        window.onclick = function(e) {
            if (!e.target.closest('.user-btn')) {
                const menu = document.querySelector('.dropdown-menu');
                if(menu) menu.classList.remove('show');
            }
        }
    </script>
</body>
</html>